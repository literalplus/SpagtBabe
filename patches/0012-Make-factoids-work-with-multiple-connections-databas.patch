From 41b751bfa84175429c78c80a4593b4c4e1d88dce Mon Sep 17 00:00:00 2001
From: xxyy <devnull@nowak-at.net>
Date: Sun, 6 Apr 2014 02:30:15 +0200
Subject: [PATCH] Make factoids work with multiple connections/databases, Fix a
 small output inconsistency with factoids.

---
 plugins/factoids.py | 24 ++++++++++++------------
 1 file changed, 12 insertions(+), 12 deletions(-)

diff --git a/plugins/factoids.py b/plugins/factoids.py
index eb4973c..82f6d0e 100644
--- a/plugins/factoids.py
+++ b/plugins/factoids.py
@@ -7,7 +7,7 @@ from util import hook, http, text, pyexec
 
 re_lineends = re.compile(r'[\r\n]*')
 
-db_ready = False
+db_ready = []
 
 # some simple "shortcodes" for formatting purposes
 shortcodes = {
@@ -19,13 +19,13 @@ shortcodes = {
     '[/i]': '\x16'}
 
 
-def db_init(db):
+def db_init(db, conn):
     global db_ready
-    if not db_ready:
+    if not conn.name in db_ready:
         db.execute("create table if not exists mem(word, data, nick,"
                    " primary key(word))")
         db.commit()
-        db_ready = True
+        db_ready.append(conn.name)
 
 
 def get_memory(db, word):
@@ -39,10 +39,10 @@ def get_memory(db, word):
 
 @hook.command("r", permissions=["addfactoid"])
 @hook.command(permissions=["addfactoid"])
-def remember(inp, nick='', db=None, notice=None):
+def remember(inp, nick='', db=None, notice=None, conn=None):
     """remember <word> [+]<data> -- Remembers <data> with <word>. Add +
     to <data> to append."""
-    db_init(db)
+    db_init(db, conn)
 
     append = False
 
@@ -71,7 +71,7 @@ def remember(inp, nick='', db=None, notice=None):
 
     if old_data:
         if append:
-            notice(u"Appending \x02{}\x02 to \x02{}\x02".format(new_data, old_data))
+            notice(u"Appending \x02{}\x02 to \x02{}\x02. Type ?{} to see it.".format(new_data, old_data, word))
         else:
             notice(u'Remembering \x02{}\x02 for \x02{}\x02. Type ?{} to see it.'.format(data, word, word))
             notice(u'Previous data was \x02{}\x02'.format(old_data))
@@ -81,10 +81,10 @@ def remember(inp, nick='', db=None, notice=None):
 
 @hook.command("f", permissions=["delfactoid"])
 @hook.command(permissions=["delfactoid"])
-def forget(inp, db=None, notice=None):
+def forget(inp, db=None, notice=None, conn=None):
     """forget <word> -- Forgets a remembered <word>."""
 
-    db_init(db)
+    db_init(db, conn)
     data = get_memory(db, inp)
 
     if data:
@@ -99,10 +99,10 @@ def forget(inp, db=None, notice=None):
 
 
 @hook.command
-def info(inp, notice=None, db=None):
+def info(inp, notice=None, db=None, conn=None):
     """info <factoid> -- Shows the source of a factoid."""
 
-    db_init(db)
+    db_init(db, conn)
 
     # attempt to get the factoid from the database
     data = get_memory(db, inp.strip())
@@ -121,7 +121,7 @@ def factoid(inp, message=None, db=None, bot=None, action=None, conn=None, input=
     except KeyError:
         prefix_on = False
 
-    db_init(db)
+    db_init(db, conn)
 
     # split up the input
     split = inp.group(1).strip().split(" ")
-- 
1.8.3.msysgit.0

